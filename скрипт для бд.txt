-- 1. Таблица ролей
CREATE TABLE roles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL
);

-- 2. Таблица пользователей
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE,
    role_id INT NOT NULL,
    FOREIGN KEY (role_id) REFERENCES roles(id)
);

-- 3. Таблица тестов
CREATE TABLE tests (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    created_by INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    time_limit INT,
    is_published BOOLEAN DEFAULT FALSE,
    passing_score DECIMAL(5,2),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- 4. Таблица категорий
CREATE TABLE categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) UNIQUE NOT NULL,
    parent_id INT NULL,
    FOREIGN KEY (parent_id) REFERENCES categories(id)
);

-- 5. Таблица вопросов
CREATE TABLE questions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    test_id INT NOT NULL,
    question_text TEXT NOT NULL,
    question_type ENUM('single_choice', 'multiple_choice', 'text') NOT NULL,
    points INT DEFAULT 1,
    display_order INT DEFAULT 0,
    FOREIGN KEY (test_id) REFERENCES tests(id)
);

-- 6. Таблица ответов
CREATE TABLE answers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    question_id INT NOT NULL,
    answer_text TEXT NOT NULL,
    is_correct BOOLEAN NOT NULL,
    FOREIGN KEY (question_id) REFERENCES questions(id)
);

-- 7. Таблица сессий тестирования
CREATE TABLE test_sessions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    test_id INT NOT NULL,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    time_spent INT,
    score_achieved DECIMAL(5,2),
    passed BOOLEAN,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (test_id) REFERENCES tests(id)
);

-- 8. Таблица ответов пользователей
CREATE TABLE user_answers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    test_session_id INT NOT NULL,
    question_id INT NOT NULL,
    answer_id INT NULL,
    answer_text TEXT,
    is_correct BOOLEAN,
    FOREIGN KEY (test_session_id) REFERENCES test_sessions(id),
    FOREIGN KEY (question_id) REFERENCES questions(id),
    FOREIGN KEY (answer_id) REFERENCES answers(id)
);

-- 9. Таблица тегов
CREATE TABLE tags (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL
);

-- 10. Связующая таблица тестов и категорий
CREATE TABLE test_categories (
    test_id INT NOT NULL,
    category_id INT NOT NULL,
    PRIMARY KEY (test_id, category_id),
    FOREIGN KEY (test_id) REFERENCES tests(id),
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- 1. Заполнение таблицы ролей
INSERT INTO roles (name) VALUES 
('Администратор'),
('Преподаватель'),
('Студент'),
('Модератор');

-- 2. Заполнение таблицы пользователей
INSERT INTO users (username, email, password_hash, first_name, last_name, role_id) VALUES 
('admin', 'admin@university.edu', 'hashed_password_123', 'Иван', 'Петров', 1),
('teacher1', 'teacher1@university.edu', 'hashed_password_456', 'Мария', 'Сидорова', 2),
('teacher2', 'teacher2@university.edu', 'hashed_password_789', 'Алексей', 'Козлов', 2),
('student1', 'student1@university.edu', 'hashed_password_111', 'Анна', 'Иванова', 3),
('student2', 'student2@university.edu', 'hashed_password_222', 'Дмитрий', 'Смирнов', 3),
('student3', 'student3@university.edu', 'hashed_password_333', 'Ольга', 'Кузнецова', 3);

-- 3. Заполнение таблицы категорий
INSERT INTO categories (name, parent_id) VALUES 
('Программирование', NULL),
('Математика', NULL),
('Базы данных', 1),
('Веб-разработка', 1),
('Алгебра', 2),
('Геометрия', 2);

-- 4. Заполнение таблицы тестов
INSERT INTO tests (title, description, created_by, time_limit, is_published, passing_score) VALUES 
('Основы SQL', 'Тест по основам языка SQL и реляционных баз данных', 2, 30, TRUE, 70.0),
('Введение в Python', 'Базовый тест по программированию на Python', 2, 45, TRUE, 65.0),
('Алгебра для начинающих', 'Основные понятия алгебры', 3, 60, TRUE, 75.0),
('HTML и CSS', 'Основы веб-разработки', 3, 25, FALSE, 60.0);

-- 5. Заполнение таблицы тестов и категорий
INSERT INTO test_categories (test_id, category_id) VALUES 
(1, 3), (1, 1),
(2, 1),
(3, 5), (3, 2),
(4, 4), (4, 1);

-- 6. Заполнение таблицы тегов
INSERT INTO tags (name) VALUES 
('программирование'),
('базы данных'),
('математика'),
('веб'),
('алгоритмы'),
('тестирование');

-- 7. Заполнение таблицы вопросов для теста по SQL
INSERT INTO questions (test_id, question_text, question_type, points, display_order) VALUES 
(1, 'Что означает аббревиатура SQL?', 'single_choice', 2, 1),
(1, 'Какие из следующих команд относятся к DML?', 'multiple_choice', 3, 2),
(1, 'Что такое первичный ключ?', 'single_choice', 2, 3),
(1, 'Опишите назначение оператора JOIN', 'text', 3, 4),
(1, 'Какие типы JOIN вы знаете?', 'multiple_choice', 4, 5);

-- 8. Заполнение таблицы ответов для вопросов по SQL
INSERT INTO answers (question_id, answer_text, is_correct) VALUES 
-- Ответы для вопроса 1
(1, 'Structured Query Language', TRUE),
(1, 'Simple Question Language', FALSE),
(1, 'Standard Query Logic', FALSE),
(1, 'System Query Language', FALSE),

-- Ответы для вопроса 2
(2, 'SELECT', TRUE),
(2, 'CREATE', FALSE),
(2, 'INSERT', TRUE),
(2, 'UPDATE', TRUE),
(2, 'ALTER', FALSE),

-- Ответы для вопроса 3
(3, 'Уникальный идентификатор записи в таблице', TRUE),
(3, 'Поле для хранения паролей', FALSE),
(3, 'Индекс для ускорения поиска', FALSE),
(3, 'Внешняя ссылка на другую таблицу', FALSE),

-- Ответы для вопроса 4 (текстовый вопрос - правильный ответ в user_answers)
(4, 'Оператор JOIN используется для объединения данных из двух или более таблиц', TRUE),

-- Ответы для вопроса 5
(5, 'INNER JOIN', TRUE),
(5, 'LEFT JOIN', TRUE),
(5, 'RIGHT JOIN', TRUE),
(5, 'FULL JOIN', TRUE),
(5, 'CROSS JOIN', TRUE);

-- 9. Заполнение таблицы сессий тестирования
INSERT INTO test_sessions (user_id, test_id, started_at, completed_at, time_spent, score_achieved, passed) VALUES 
(4, 1, '2024-01-15 10:00:00', '2024-01-15 10:25:00', 1500, 85.5, TRUE),
(5, 1, '2024-01-15 11:30:00', '2024-01-15 11:50:00', 1200, 92.0, TRUE),
(6, 1, '2024-01-15 14:00:00', '2024-01-15 14:20:00', 1200, 65.5, FALSE),
(4, 2, '2024-01-16 09:00:00', '2024-01-16 09:35:00', 2100, 78.0, TRUE);

-- 10. Заполнение таблицы ответов пользователей
INSERT INTO user_answers (test_session_id, question_id, answer_id, answer_text, is_correct) VALUES 
-- Ответы студента 1 на тест по SQL
(1, 1, 1, NULL, TRUE),  -- Правильный ответ на вопрос 1
(1, 2, 1, NULL, TRUE),  -- SELECT
(1, 2, 3, NULL, TRUE),  -- INSERT
(1, 2, 4, NULL, TRUE),  -- UPDATE
(1, 3, 9, NULL, TRUE),  -- Правильный ответ на вопрос 3
(1, 4, NULL, 'JOIN используется для объединения данных из нескольких таблиц по связанным полям', TRUE),
(1, 5, 12, NULL, TRUE), -- INNER JOIN
(1, 5, 13, NULL, TRUE), -- LEFT JOIN
(1, 5, 14, NULL, TRUE), -- RIGHT JOIN

-- Ответы студента 2 на тест по SQL
(2, 1, 1, NULL, TRUE),
(2, 2, 1, NULL, TRUE),
(2, 2, 3, NULL, TRUE),
(2, 2, 4, NULL, TRUE),
(2, 3, 9, NULL, TRUE),
(2, 4, NULL, 'Оператор JOIN объединяет строки из двух или более таблиц на основе связанного столбца между ними', TRUE),
(2, 5, 12, NULL, TRUE),
(2, 5, 13, NULL, TRUE),
(2, 5, 14, NULL, TRUE),
(2, 5, 15, NULL, TRUE),
(2, 5, 16, NULL, TRUE);

-- Добавим также вопросы для теста по Python
INSERT INTO questions (test_id, question_text, question_type, points, display_order) VALUES 
(2, 'Какой оператор используется для вывода данных в Python?', 'single_choice', 2, 1),
(2, 'Какие из следующих типов данных являются изменяемыми?', 'multiple_choice', 3, 2);

INSERT INTO answers (question_id, answer_text, is_correct) VALUES 
-- Ответы для вопроса по Python 1
(6, 'print()', TRUE),
(6, 'echo()', FALSE),
(6, 'output()', FALSE),
(6, 'console.log()', FALSE),

-- Ответы для вопроса по Python 2
(7, 'list', TRUE),
(7, 'tuple', FALSE),
(7, 'dict', TRUE),
(7, 'set', TRUE),
(7, 'str', FALSE);

-- Добавим сессии для теста по Python
INSERT INTO test_sessions (user_id, test_id, started_at, completed_at, time_spent, score_achieved, passed) VALUES 
(5, 2, '2024-01-17 10:00:00', '2024-01-17 10:38:00', 2280, 82.5, TRUE);

-- Ответы студента 2 на тест по Python
INSERT INTO user_answers (test_session_id, question_id, answer_id, answer_text, is_correct) VALUES 
(5, 6, 17, NULL, TRUE),  -- print()
(5, 7, 19, NULL, TRUE),  -- list
(5, 7, 21, NULL, TRUE),  -- dict
(5, 7, 22, NULL, TRUE);  -- set